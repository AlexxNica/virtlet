#!/bin/bash

trace() {
  $*
  retval=$?
  if [ $retval -ne 0 ] ; then
    exit $retval
  fi
}

cleanup() {
  if [ ! -z "${HTTP_SERVER_PID}" ] ; then
    kill ${HTTP_SERVER_PID}
  fi
}

trap cleanup SIGHUP SIGINT SIGTERM EXIT

mkdir -p /tmp/image_store
pushd /tmp/image_store
trace curl http://download.cirros-cloud.net/0.3.3/cirros-0.3.3-x86_64-disk.img -o cirros-0.3.3-x86_64-disk.img
trace curl http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img -o cirros-0.3.4-x86_64-disk.img
ln -s . copy
python -m SimpleHTTPServer 80 >/tmp/http_server.log &
HTTP_SERVER_PID=$!
popd

if [ $# -ne 0 ] ; then
  go test -test.v -run $*
  retval=$?
else
  go test -v .
  retval=$?
fi

exit $retval
